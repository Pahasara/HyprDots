#!/bin/bash

## This script allows getting currently playing track information

## Features:
## - Trims track information to a specified maximum length
## - Supports optional max_length argument for customizing display length
## - Configurable players list for easy customization

## Requirements:
## - `playerctl`: For retrieving media player track information

## Author: Pahasara Dewnith (https://github.com/Pahasara)

default_max_length=32
PLAYERS=("spotify" "Lollypop" "firefox")

# Icons
ICON_SPOTIFY=""
ICON_LOLLYPOP=""
ICON_FIREFOX=""
ICON_GENERIC=""

trim_info() {
    local info="$1"
    local max_length="$2"
    
    if [ ${#info} -gt $max_length ]; then
        local trim_length=$((max_length - 1))
        local trimmed="${info:0:$trim_length}"
        
        trimmed=$(echo "$trimmed" | sed 's/ ✦ *$//; s/✦ *$//')
        
        info="${trimmed}…"
    fi
    echo "$info"
}

if [[ $1 =~ max_length=([0-9]+) ]]; then
    max_length="${BASH_REMATCH[1]}"
else
    max_length=$default_max_length
fi

detect_icon() {
    local player="$1"

    case "$player" in
        spotify*)      echo "$ICON_SPOTIFY" ;;
        Lollypop*)     echo "$ICON_LOLLYPOP" ;;
        firefox*|org.mpris.MediaPlayer2.firefox*) echo "$ICON_FIREFOX" ;;
        *)             echo "$ICON_GENERIC" ;;
    esac
}

output=""

# Check preferred players first
for player in "${PLAYERS[@]}"; do
    if playerctl --player="$player" status 2>/dev/null | grep -q "Playing"; then
        info=$(playerctl metadata --player="$player" --format '{{title}} ✦ {{artist}} ')
        trimmed_info=$(trim_info "$info" "$max_length")
        icon=$(detect_icon "$player")
        output="$icon $trimmed_info"
        break
    fi
done

# Fallback: any player
if [ -z "$output" ]; then
    active_player=$(playerctl --list-players 2>/dev/null | head -n 1)
    if [[ -n "$active_player" ]] && playerctl --player="$active_player" status 2>/dev/null | grep -q "Playing"; then
        info=$(playerctl metadata --player="$active_player" --format '{{title}} ✦ {{artist}} ')
        trimmed_info=$(trim_info "$info" "$max_length")
        icon=$(detect_icon "$active_player")
        output="$icon $trimmed_info"
    fi
fi

echo "$output"
