#!/bin/bash

Gefault_max_length=32
DISABLE_BROWSER=0

PLAYERS=("spotify" "Lollypop" "firefox")

ICON_SPOTIFY=""
ICON_LOLLYPOP=""
ICON_FIREFOX=""
ICON_GENERIC=""

for arg in "$@"; do
    case "$arg" in
        max_length=*)
            max_length="${arg#max_length=}"
            ;;
        --no-browser)
            DISABLE_BROWSER=1
            ;;
    esac
done

max_length="${max_length:-$default_max_length}"

trim_info() {
    local info="$1"
    local max="$2"

    if (( ${#info} > max )); then
        local cut_point=$((max - 3))
        info="${info:0:cut_point}"
        info="$(sed 's/ ✦ *$//; s/✦ *$//; s/[[:space:]]*$//' <<< "$info")…"
    fi
    echo "$info"
}

detect_icon() {
    case "$1" in
        spotify*)   echo "$ICON_SPOTIFY" ;;
        Lollypop*)  echo "$ICON_LOLLYPOP" ;;
        firefox*|org.mpris.MediaPlayer2.firefox*)
                     echo "$ICON_FIREFOX" ;;
        *)          echo "$ICON_GENERIC" ;;
    esac
}

is_browser_player() {
    [[ "$1" == firefox* || "$1" == org.mpris.MediaPlayer2.firefox* ]]
}

output=""

for player in "${PLAYERS[@]}"; do
    if (( DISABLE_BROWSER )) && is_browser_player "$player"; then
        continue
    fi

    if playerctl --player="$player" status 2>/dev/null | grep -q "Playing"; then
        info="$(playerctl metadata --player="$player" --format '{{title}} ✦ {{artist}}')"
        output="$(detect_icon "$player")  $(trim_info "$info" "$max_length")"
        break
    fi
done

if [[ -z "$output" ]]; then
    while read -r player; do
        if (( DISABLE_BROWSER )) && is_browser_player "$player"; then
            continue
        fi

        if playerctl --player="$player" status 2>/dev/null | grep -q "Playing"; then
            info="$(playerctl metadata --player="$player" --format '{{title}} ✦ {{artist}}')"
            output="$(detect_icon "$player")  $(trim_info "$info" "$max_length")"
            break
        fi
    done < <(playerctl --list-players 2>/dev/null)
fi

echo "$output"
