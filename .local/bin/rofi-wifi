#!/usr/bin/bash
#
# Rofi Wi-Fi Manager
# A simple network selector using nmcli + rofi with notifications.
#
# Capabilities:
#   • Toggle Wi-Fi on/off
#   • List available networks (secure/connected marked)
#   • Connect to saved or new networks (with password prompt)
#   • Notify success/failure via dunst + sound-alert
#
# Dependencies: nmcli, rofi, dunstify, sound-alert
# Author: Pahasara Dewnith  |  https://github.com/Pahasara

# --- CONFIG -----------------------------------------------------
ICON_WIFI="$HOME/.local/share/icons/dunst/wifi.png"
ICON_CAUTION="$HOME/.local/share/icons/dunst/caution.png"
SOUND_NOTIFY="$HOME/.local/bin/sound-alert"
SOUND_ERROR="$HOME/.local/bin/sound-alert --error"
TIME_DURATION=4000

EMOJI_WIFI=" "
EMOJI_LOCK=" "
EMOJI_POWER=" "

ROFI_CONFIG="$HOME/.config/rofi/presets/wifi.rasi"

# --- DEPENDENCY CHECK ------------------------------------------
for cmd in nmcli rofi dunstify; do
    command -v "$cmd" >/dev/null 2>&1 || {
        echo "Error: '$cmd' command not found"
        exit 1
    }
done

# --- CURRENT CONNECTION ----------------------------------------
current_connection=$(nmcli -t -f active,ssid dev wifi \
    | awk -F: '/^yes:/ {print $2}')

# --- WIFI LIST PARSING (CLEAN, SAFE, UTF-8, MULTI-WORD SSID) ---
wifi_list=$(
    nmcli -t -f ssid,security dev wifi \
    | while IFS=: read -r ssid sec; do
        # Skip empty SSIDs (hidden networks)
        [ -z "$ssid" ] && continue

        if [ "$ssid" = "$current_connection" ]; then
            echo "$EMOJI_WIFI $ssid"
        else
            echo "$EMOJI_LOCK $ssid"
        fi
    done
)

# --- WIFI TOGGLE STATE -----------------------------------------
wifi_state=$(nmcli -t -f WIFI g)
if [[ "$wifi_state" == "enabled" ]]; then
    toggle="$EMOJI_POWER Disable Wi-Fi"
else
    toggle="$EMOJI_POWER Enable Wi-Fi"
fi

# --- ROFI MENU --------------------------------------------------
chosen_network=$(printf "%s\n%s\n" "$toggle" "$wifi_list" \
    | rofi -dmenu -i -p "Wi-Fi SSID:" -config "$ROFI_CONFIG")

# No selection
[ -z "$chosen_network" ] && exit 0

# --- EXTRACT SSID SAFELY (REMOVE FIRST TOKEN ONLY) -------------
chosen_id=$(echo "$chosen_network" | sed 's/^[^[:alnum:]]* *//')

# --- HANDLE TOGGLE ---------------------------------------------
if [[ "$chosen_network" == "$EMOJI_POWER Disable Wi-Fi" ]]; then
    nmcli radio wifi off
    exit 0
fi

if [[ "$chosen_network" == "$EMOJI_POWER Enable Wi-Fi" ]]; then
    nmcli radio wifi on
    exit 0
fi

# --- CONNECTING LOGIC ------------------------------------------
success_msg="Connected to \"$chosen_id\""

# Check if saved connection exists
if nmcli -g NAME connection | grep -Fxq "$chosen_id"; then
    if nmcli connection up id "$chosen_id"; then
        dunstify -t "$TIME_DURATION" -u low -I "$ICON_WIFI" "$success_msg"
        $SOUND_NOTIFY
    else
        dunstify -u low -I "$ICON_CAUTION" "Failed to connect to $chosen_id"
        $SOUND_ERROR
    fi
else
    # Prompt password for new connection
    wifi_password=$(rofi -dmenu -p "Password:" -password)

    [ -z "$wifi_password" ] && exit 0

    nmcli device wifi rescan
    sleep 1

    if nmcli device wifi connect "$chosen_id" password "$wifi_password"; then
        dunstify -t "$TIME_DURATION" -u low -I "$ICON_WIFI" "$success_msg"
        $SOUND_NOTIFY
    else
        dunstify -u low -I "$ICON_CAUTION" "Wrong password? Failed to connect to $chosen_id"
        nmcli connection delete "$chosen_id" >/dev/null 2>&1
        $SOUND_ERROR
    fi
fi
